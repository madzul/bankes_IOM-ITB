generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  user_id       Int       @id @default(autoincrement()) @unique
  name          String
  email         String    @unique
  password      String?
  role          Role

  Students      Student[] 
  Interviews    Interview[]
  NotificationEndpoints NotificationEndpoint[]
  Notifications  Notification[]
  ParticipatedInterviews InterviewParticipant[]
}

model Student {
  student_id    Int       @id @default(autoincrement()) @unique
  nim           String
  faculty       String
  major         String

  Files         File[]
  Statuses      Status[]
  Interviews    Interview[]
  InterviewSlots InterviewSlot[]

  User          User     @relation(fields: [student_id], references: [user_id])
  notes        Notes[]
}

model File {
  file_id       Int       @id @default(autoincrement())
  student_id    Int
  file_url      String
  file_name     String
  type          FileType

  Student       Student  @relation(fields: [student_id], references: [student_id])
}

model Status {
  student_id    Int
  period_id     Int
  passDitmawa    Boolean
  passIOM       Boolean
  passInterview Boolean
  amount        Int?
  Student       Student  @relation(fields: [student_id], references: [student_id])
  Period        Period   @relation(fields: [period_id], references: [period_id])

  @@id([student_id, period_id]) 
}

model Period {
  period_id     Int       @id @default(autoincrement())
  period        String
  start_date    DateTime
  end_date      DateTime
  is_current    Boolean
  is_open	Boolean

  Statuses      Status[]
  Interviews    Interview[]
}

model Interview {
  interview_id Int      @id @default(autoincrement())
  title        String? 
  description  String? 
  student_id   Int? 
  user_id      Int 
  period_id    Int
  start_time   DateTime
  end_time     DateTime
  max_students Int      @default(1)

  Student      Student? @relation(fields: [student_id], references: [student_id])
  User         User     @relation(fields: [user_id], references: [user_id])
  Period       Period   @relation(fields: [period_id], references: [period_id])

  participants InterviewParticipant[]
  slots        InterviewSlot[]
  notes        Notes[]
}

model Notes {
  interview_id Int
  student_id   Int
  text         String

  @@id([interview_id, student_id])

  interview    Interview @relation(fields: [interview_id], references: [interview_id])
  student      Student   @relation(fields: [student_id], references: [student_id])
}

model InterviewParticipant {
  id           Int      @id @default(autoincrement())
  interview_id Int
  user_id      Int 
  joined_at    DateTime @default(now())
  slot_id      Int? // Add this field to track which specific slot they're joining

  Interview  Interview     @relation(fields: [interview_id], references: [interview_id], onDelete: Cascade)
  User       User          @relation(fields: [user_id], references: [user_id])
  Slot       InterviewSlot? @relation(fields: [slot_id], references: [id])

  @@unique([interview_id, user_id])
}

model InterviewSlot {
  id           Int       @id @default(autoincrement())
  interview_id Int
  student_id   Int? 
  slot_number  Int 
  start_time   DateTime
  end_time     DateTime
  booked_at    DateTime?

  Interview Interview @relation(fields: [interview_id], references: [interview_id], onDelete: Cascade)
  Student   Student?  @relation(fields: [student_id], references: [student_id])
  
  // Add this relation to connect participants to specific slots
  Participants InterviewParticipant[]

  @@unique([interview_id, slot_number])
}


model NotificationEndpoint {
  user_id  Int
  endpoint String
  keys     Json
  createdAt DateTime @default(now())

  User     User @relation(fields: [user_id], references: [user_id])

  @@id([user_id, endpoint]) 
}

model Notification {
  notification_id Int     @id @default(autoincrement()) 
  user_id         Int     
  header          String
  body            String
  url             String? 
  has_read        Boolean @default(false)
  created_at      DateTime @default(now())

  User           User @relation(fields: [user_id], references: [user_id])
  @@index([user_id])
}

enum FileType {
  KTM
  KTP
  CV
  Transkrip_Nilai
}

enum Role {
  Admin
  Mahasiswa
  Guest
  Pengurus_IOM
}
