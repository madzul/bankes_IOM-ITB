generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  user_id  Int     @id @unique @default(autoincrement())
  name     String
  email    String  @unique
  password String?
  role     Role

  Students               Student[]
  NotificationEndpoints  NotificationEndpoint[]
  Notifications          Notification[]
  ParticipatedInterviews InterviewParticipant[]
  InterviewSlot          InterviewSlot[]
}

model Student {
  student_id Int    @id @unique @default(autoincrement())
  nim        String
  faculty    String
  major      String

  Files          File[]
  Statuses       Status[]
  InterviewSlots InterviewSlot[]

  User  User    @relation(fields: [student_id], references: [user_id])
  notes Notes[]
}

model File {
  file_id    Int      @id @default(autoincrement())
  student_id Int
  file_url   String
  file_name  String
  type       FileType

  Student Student @relation(fields: [student_id], references: [student_id])
}

model Status {
  student_id    Int
  period_id     Int
  passDitmawa   Boolean
  passIOM       Boolean
  passInterview Boolean
  amount        Int?
  Student       Student @relation(fields: [student_id], references: [student_id])
  Period        Period  @relation(fields: [period_id], references: [period_id])

  @@id([student_id, period_id])
}

model Period {
  period_id  Int      @id @default(autoincrement())
  period     String
  start_date DateTime
  end_date   DateTime
  is_current Boolean
  is_open    Boolean

  Statuses      Status[]
  InterviewSlot InterviewSlot[]
}

model Notes {
  slot_id    Int // Change from interview_id to slot_id
  student_id Int
  text       String

  slot    InterviewSlot @relation(fields: [slot_id], references: [id]) // Change relation
  student Student       @relation(fields: [student_id], references: [student_id])

  @@id([slot_id, student_id])
}

model InterviewParticipant {
  id        Int      @id @default(autoincrement())
  slot_id   Int      // Only need slot_id now, not interview_id
  user_id   Int
  joined_at DateTime @default(now())

  Slot InterviewSlot @relation(fields: [slot_id], references: [id], onDelete: Cascade)
  User User          @relation(fields: [user_id], references: [user_id])

  @@unique([slot_id, user_id])
}

model InterviewSlot {
  id          Int       @id @default(autoincrement())
  title       String?
  description String?
  user_id     Int       // The creator
  period_id   Int
  start_time  DateTime
  end_time    DateTime
  student_id  Int?      // Student who booked the slot
  booked_at   DateTime?

  // Relations
  Student      Student?               @relation(fields: [student_id], references: [student_id])
  User         User                   @relation(fields: [user_id], references: [user_id])
  Period       Period                 @relation(fields: [period_id], references: [period_id])
  Participants InterviewParticipant[]
  notes        Notes[]
}

model NotificationEndpoint {
  user_id   Int
  endpoint  String
  keys      Json
  createdAt DateTime @default(now())

  User User @relation(fields: [user_id], references: [user_id])

  @@id([user_id, endpoint])
}

model Notification {
  notification_id Int      @id @default(autoincrement())
  user_id         Int
  header          String
  body            String
  url             String?
  has_read        Boolean  @default(false)
  created_at      DateTime @default(now())

  User User @relation(fields: [user_id], references: [user_id])

  @@index([user_id])
}

enum FileType {
  KTP
  CV
  Transkrip_Nilai
}

enum Role {
  Admin
  Mahasiswa
  Guest
  Pengurus_IOM
}
