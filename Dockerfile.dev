# Dockerfile.dev
FROM node:23-slim

# 1) Install OS deps (Prisma needs openssl, plus bash & curl for scripts)
RUN apt-get update \
 && apt-get install -y --no-install-recommends \
      openssl \
      bash \
      curl \
 && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# 2) Dev flags
ARG NODE_ENV=development
ENV NODE_ENV=${NODE_ENV}
ENV NEXT_TELEMETRY_DISABLED=1

# 3) Install everything
COPY package.json package-lock.json ./
RUN npm ci

# 4) Prisma client
COPY prisma ./prisma
RUN npx prisma generate

# 5) MinIO init script
COPY scripts/minio-init.sh ./scripts/minio-init.sh
RUN chmod +x ./scripts/minio-init.sh

# 6) Your source
COPY . .

# 7) Lint + type-check (now after source is copied)
# RUN npm run lint && npx tsc --noEmit

# COPY entrypoint.sh /usr/local/bin/entrypoint.sh
# RUN chmod +x /usr/local/bin/entrypoint.sh

# 8) Dev server
EXPOSE 3031

CMD ["bash", "-c", "npx prisma migrate deploy && npm run dev"]